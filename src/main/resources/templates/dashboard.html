<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .interaction-buttons button, .interaction-buttons a {
            margin-top: 5px;
        }
        .card-img-top {
            max-height: 300px;
            object-fit: contain;
        }
        .comment-box {
            margin-top: 10px;
        }
        .comment-list {
            margin-top: 5px;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- ‚úÖ Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container mt-4">
        <h3>Welcome to the Dashboard!</h3>
        <p>You can post images/videos here daily.</p>

        <!-- ‚úÖ Upload Button visible only for ADMIN -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
                <a href="/upload" class="btn btn-primary">Upload Content</a>
            </div>

            <!-- Search Bar -->
            <form class="d-flex" th:action="@{/dashboard}" method="get">
                <input class="form-control me-2" type="search" name="keyword" 
                       placeholder="Search by title or description" 
                       th:value="${keyword}">
                <button class="btn btn-outline-success me-2" type="submit">Search</button>
                <a th:href="@{/dashboard}" class="btn btn-outline-secondary">Clear</a>
            </form>
        </div>

        <!-- ‚úÖ Display Uploaded Content -->
        <div class="row mt-4" th:if="${contents != null}">
            <h4>Uploaded Content</h4>

            <!-- No results -->
            <div th:if="${#lists.isEmpty(contents)}" class="text-center text-muted mt-4">
                <p>No content found.</p>
            </div>

            <!-- Cards -->
            <div class="col-md-4 mb-3" th:each="c : ${contents}">
                <div class="card shadow-sm h-100">
                    <!-- Image -->
                    <div th:if="${c.fileType == 'image'}">
                        <img th:src="@{${c.filePath}}" class="card-img-top" alt="Image">
                    </div>
                    <!-- Video -->
                    <div th:if="${c.fileType == 'video'}">
                        <video th:src="@{${c.filePath}}" class="card-img-top" controls></video>
                    </div>

                    <div class="card-body">
                        <h5 th:text="${c.title}"></h5>
                        <p th:text="${c.description}"></p>
                        <p class="text-muted small" th:text="'Type: ' + ${c.fileType}"></p>

                        <!-- Like, Comment, Share -->
                        <div class="interaction-buttons mt-2">
                            <!-- Like -->
                            <form th:action="@{/content/like/{id}(id=${c.id})}" method="post" style="display:inline;">
                                <button class="btn btn-outline-primary btn-sm w-100" type="submit">
                                    üëç Like (<span th:text="${c.likes}">0</span>)
                                </button>
                            </form>

                            <!-- Comment -->
                            <button class="btn btn-outline-secondary btn-sm w-100 mt-1"
                                    type="button" 
                                    onclick="toggleCommentBox(this)">üí¨ Comment</button>

                            <!-- Share -->
                            <button class="btn btn-outline-success btn-sm w-100 mt-1"
                                    type="button"
                                    onclick="shareWhatsApp('Check this content: ' + this.getAttribute('data-link'))"
                                    th:attr="data-link=${c.filePath}">üîó Share</button>
                        </div>

                        <!-- Comment Box -->
                        <div class="comment-box" style="display:none;">
                            <form th:action="@{/content/comment/{id}(id=${c.id})}" method="post">
                                <textarea name="comment" class="form-control mt-2" placeholder="Write a comment..." required></textarea>
                                <button class="btn btn-sm btn-primary mt-1" type="submit">Post</button>
                            </form>

                            <!-- Show Comments -->
                            <div class="comment-list" th:if="${c.comments != null}" th:text="${c.comments}"></div>
                        </div>

                        <!-- ‚úÖ Delete only for ADMIN -->
                        <form th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
                              th:action="@{/content/delete/{id}(id=${c.id})}" method="post"
                              onsubmit="return confirm('Are you sure you want to delete this content?');">
                            <button class="btn btn-danger btn-sm mt-3" type="submit">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advertisement -->
        <div class="mt-5 p-3 bg-light border rounded">
            <h5>Advertisement Section</h5>
            <p>Ad space placeholder...</p>
        </div>
    </div>

    <!-- ‚úÖ JS -->
    <script>
        function toggleCommentBox(button) {
            const commentBox = button.closest('.card-body').querySelector('.comment-box');
            commentBox.style.display = commentBox.style.display === 'none' ? 'block' : 'none';
        }

        function shareWhatsApp(text) {
            const encoded = encodeURIComponent(text);
            const url = 'https://wa.me/?text=' + encoded;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
